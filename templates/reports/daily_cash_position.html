{% extends '../base.html' %}
{% load static %}
{% load humanize %}
{% load form_tags %}

{% block title %}Daily Cash Position{% endblock title %}
{% block page_title %}Daily Cash Position{% endblock page_title %}

{% block css %}
    <style>
        .bottom-border {
            border-bottom: 1px solid black;
        }
        .bottom-border-3 {
            border-bottom: 3px solid black;
        }
    </style>
{% endblock css %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
    <li class="breadcrumb-item active">Daily Cash Position</li>
{% endblock breadcrumb %}

{% block main_content %}
    <div class="card m-4 no-print">
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-md-2">
                    <p class="card-text text-muted">Date:</p>
                </div>
                <div class="col-md-4">
                    <input type="date" name="date" id="date" class="form-control" value="{{ sel_date|date:'Y-m-d' }}"/>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="row">
                <div class="col-lg-12">
                    <button class="btn btn-primary" id="btn_set">Set</button>
                </div>
            </div>
        </div>
    </div>

    {% if cash_position != None %}
    <div class="card m-4" id="report">
        <div class="card-header text-center">
            <h5>V.B. Queen's Jewelry and Pawnshop</h5>
            <h6>{{ selected_branch }}</h6>
            <br>
            <h5>DAILY CASH POSITION REPORT</h5>
        </div>
        <div class="card-body">
            <div class="row mb-2">
                <div class="col-12">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card-text text-right">Date: {{ cash_position.date|date:"F m, Y" }}</div>
                            <div>No. <u>{{ cash_position.pk|stringformat:"06d" }}</u></div>
                            <div class="ml-2">Balance as of <u>{{ last.date|date:"F m, Y" }}</u></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-2">Cash on Hand</div>
                        <div class="col-md-1"></div>
                        <div class="col-md-3 text-right bottom-border">{{ cash_position.balance_coh|peso }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-2">Cash in Bank</div>
                        <div class="col-md-1"></div>
                        <div class="col-md-3 text-right bottom-border">{{ cash_position.balance_cib|peso }}</div>
                        <div class="col-md-2"></div>
                        <div class="col-md-3 text-right bottom-border">{{ cash_position.get_total_balance|peso }}</div>
                    </div>
                    <div class="row bottom-border-3 mt-4">
                        <div class="col-md-12">
                            ADD: Receipts
                            {% if is_today %}
                                <span class="float-right no-print"><a href="{% url 'add_receipt' cash_position.pk %}" class="btn btn-sm btn-outline-success">New</a></span>
                            {% endif %}
                        </div>
                    </div>
                    {% if receipts %}
                        <div class="row">
                            <div class="col-sm-2 ml-3">OR/PR No.</div>
                            <div class="col-sm-2 ml-3">Received from</div>
                            <div class="col-sm-2 ml-3">Particulars</div>
                            <div class="col-sm-2 ml-3">Amount</div>
                            <div class="col-sm-2"></div>
                        </div>
                        {% for receipt in receipts %}
                        <div class="row">
                            <div class="col-sm-2 ml-3 bottom-border">{{ receipt.reference_number|default_if_none:"" }}</div>
                            <div class="col-sm-2 ml-3 bottom-border">{{ receipt.received_from|default_if_none:"" }}</div>
                            <div class="col-sm-2 ml-3 bottom-border">{{ receipt.particulars|default_if_none:"" }}</div>
                            <div class="col-sm-2 ml-3 text-right bottom-border">{{ receipt.amount|peso }}</div>
                            {% if forloop.last %}
                            <div class="col-sm-2 ml-3 text-right bottom-border">{{ cash_position.get_total_receipts|peso }}</div>
                            {% else %}
                            <div class="col-sm-2 ml-3 bottom-border"></div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        <div class="row">
                            <div class="col-sm-7"></div>
                            <div class="col-sm-1">Total</div>
                            <div class="col-sm-4 text-right bottom-border">{{ cash_position.get_net_subtotal|peso }}</div>
                        </div>
                    {% else %}
                        <div class="row">
                            <div class="col-md-12 text-muted">No receipts found.</div>
                        </div>
                    {% endif %}

                    <br />
                    
                    <div class="row bottom-border-3 mt-4">
                        <div class="col-md-12">
                            LESS: Disbursements 
                            {% if is_today %}
                                <span class="float-right no-print"><a href="{% url 'add_disbursement' cash_position.pk %}" class="btn btn-sm btn-outline-success">New</a></span>
                            {% endif %}
                        </div>
                    </div>
                    {% if disbursements %}
                        <div class="row">
                            <div class="col-sm-2 ml-3">OR/PR No.</div>
                            <div class="col-sm-2 ml-3">Received from</div>
                            <div class="col-sm-2 ml-3">Particulars</div>
                            <div class="col-sm-2 ml-3">Amount</div>
                            <div class="col-sm-2"></div>
                        </div>
                        {% for disbursement in disbursements %}
                        <div class="row">
                            <div class="col-sm-2 ml-3 bottom-border">{{ disbursement.reference_number|default_if_none:"" }}</div>
                            <div class="col-sm-2 ml-3 bottom-border">{{ disbursement.payee|default_if_none:"" }}</div>
                            <div class="col-sm-2 ml-3 bottom-border">{{ disbursement.particulars|default_if_none:"" }}</div>
                            <div class="col-sm-2 ml-3 text-right bottom-border">{{ disbursement.amount|peso }}</div>
                            {% if forloop.last %}
                            <div class="col-sm-2 ml-3 text-right bottom-border">{{ cash_position.get_total_disbursements|peso }}</div>
                            {% else %}
                            <div class="col-sm-2 ml-3 bottom-border"></div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        <div class="row">
                            <div class="col-md-7"></div>
                            <div class="col-md-1">Total</div>
                            <div class="col-md-4 text-right bottom-border">{{ cash_position.get_net_total|peso }}</div>
                        </div>
                    {% else %}
                        <div class="row">
                            <div class="col-md-12 text-muted">No disbursements found.</div>
                        </div>
                    {% endif %}

                    <br />

                    <form action="{% url 'update_cib_brakedown' cash_position.pk %}" method="post">
                        {% csrf_token %}
                        <div class="row mt-4">
                            <h6 class="col-sm-12 text-center text-bold">CASH IN BANK BREAKDOWN</h6>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-2 ml-2">Cash in bank (date)</div>
                            <div class="col-sm-2 ml-2 bottom-border">{{ last.date|date:"F d, Y" }}</div>
                            <div class="col-sm-2 ml-2 text-right bottom-border">{{ last.balance_cib|peso }}</div>
                            <div class="col-sm-2"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-2 ml-2">Add: Deposits for the day</div>
                            <div class="col-sm-2 ml-2"></div>
                            <div class="col-sm-2 ml-2">    
                            {% if is_today %}
                                <input type="number" class="form-control text-right" name="deposits_today" id="deposits_today" value="{{ cash_position.deposits }}" />
                            {% else %}
                                {{ cash_position.deposits|peso }}
                            {% endif %}
                            </div>
                            <div class="col-sm-2"></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-2 ml-2">Total</div>
                            <div class="col-sm-2 ml-2"></div>
                            <div class="col-sm-2 ml-2 text-right">{{ cash_position.get_subtotal|peso }}</div>
                            <div class="col-sm-2"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-2 ml-2">Less: Withdrawals for the day</div>
                            <div class="col-sm-2 ml-2"></div>
                            <div class="col-sm-2 ml-2">
                            {% if is_today %}
                                <input type="number" class="form-control text-right" name="withdrawals_today" id="withdrawals_today" value="{{ cash_position.withdrawals }}" />
                            {% else %}
                                {{ cash_position.withdrawals|peso }}
                            {% endif %}
                            </div>
                            <div class="col-sm-2"></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-2 ml-2">Cash in Bank (date)</div>
                            <div class="col-sm-2 ml-2 bottom-border">{% now "F d, Y" %}</div>
                            <div class="col-sm-2 ml-2 text-right bottom-border">{{ cash_position.get_cash_in_bank|peso }}</div>
                            <div class="col-sm-2"></div>
                        </div>
                        {% if is_today %}
                        <div class="row no-print mt-4">
                            <div class="col-sm-12 text-center">
                                <button type="submit" class="btn btn-sm btn-success" id="btn_update">Update</button>
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        <div class="card-footer no-print">
            <div class="row">
                <div class="col-lg-12">
                    <button class="btn btn-primary" id="btn_print" onclick="window.print();">Print</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

{% endblock main_content %}


{% block js %}
    <script>
        $(document).ready(function() {
            $("#btn_set").click(function() {
                const date = $("#date").val()
                console.log(date)
                window.location.href = "{% url 'daily_cash_position' %}?date=" + date
            });

            $("#menu-reports").addClass("active")
        })
    </script>
{% endblock js %}